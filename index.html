<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Collection Form</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .fetch-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .customer-details {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e3f2fd;
        }

        .balance-info {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ff9800;
        }

        .balance-info h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .submit-btn {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            font-size: 16px;
        }

        .error {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 5px;
        }

        .success {
            color: #27ae60;
            font-size: 12px;
            margin-top: 5px;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        .readonly {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .amount-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        /* Phone Input Styles */
        .phone-input-container {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 10px;
            align-items: start;
        }

        .country-input-wrapper {
            position: relative;
        }

        .country-search {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .country-search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .country-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .country-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .country-option:hover,
        .country-option.highlighted {
            background: #f5f5f5;
        }

        .country-option:last-child {
            border-bottom: none;
        }

        .phone-input-wrapper {
            position: relative;
        }

        #phone {
            padding-left: 50px;
        }

        .country-code-display {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-size: 14px;
            pointer-events: none;
            background: white;
            padding: 0 5px;
        }

        .phone-preview {
            grid-column: 1 / -1;
            margin-top: 5px;
        }

        .phone-preview small {
            color: #666;
            font-style: italic;
        }

        .email-disclaimer {
            margin-top: 5px;
        }

        .email-disclaimer small {
            color: #4285f4;
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .amount-row {
                grid-template-columns: 1fr;
            }
            
            .phone-input-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Payment Collection Form</h1>
            <p>Collect and manage customer payments efficiently</p>
        </div>

        <form id="paymentForm">
            <!-- Payment Type Selection -->
            <div class="form-group">
                <label for="paymentType">Payment Type *</label>
                <select id="paymentType" required>
                    <option value="">Select Payment Type</option>
                    <option value="full">Full Payment</option>
                    <option value="partial">Partial Payment</option>
                    <option value="balance_partial">Balance Partial</option>
                    <option value="balance_completed">Balance Completed</option>
                </select>
            </div>

            <!-- Customer Lookup Section (for balance payments) -->
            <div id="customerLookup" class="fetch-section hidden">
                <h4>Find Existing Customer</h4>
                <div class="form-group">
                    <label for="lookupEmail">Customer Email *</label>
                    <input type="email" id="lookupEmail" placeholder="Enter customer email to fetch details">
                    <div id="emailError" class="error"></div>
                </div>
                <button type="button" id="fetchCustomer" class="btn">Fetch Customer Details</button>
            </div>

            <!-- Customer Details Section -->
            <div id="customerSection" class="customer-details">
                <h4>Customer Details</h4>
                <div class="form-group">
                    <label for="firstName">First Name *</label>
                    <input type="text" id="firstName" required>
                </div>
                
                <div class="form-group">
                    <label for="lastName">Last Name *</label>
                    <input type="text" id="lastName" required>
                </div>
                
                <div class="form-group">
                    <label for="phone">Phone Number *</label>
                    <div class="phone-input-container">
                        <div class="country-input-wrapper">
                            <input type="text" id="countrySearch" class="country-search" 
                                   placeholder="Type country..." autocomplete="off">
                            <div id="countryDropdown" class="country-dropdown"></div>
                        </div>
                        <div class="phone-input-wrapper">
                            <span id="countryCodeDisplay" class="country-code-display">+91</span>
                            <input type="tel" id="phone" placeholder="Enter phone number" required>
                        </div>
                    </div>
                    <div class="phone-preview">
                        <small>Format: <span id="phonePreview">+91</span></small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required>
                    <div class="email-disclaimer">
                        <small><em>ðŸ’¡ For balance payments, this field will auto-fill when customer is found</em></small>
                    </div>
                </div>
            </div>

            <!-- Balance Information (for balance payments) -->
            <div id="balanceInfo" class="balance-info hidden">
                <h4>Current Balance Information</h4>
                <p><strong>Original Quote:</strong> â‚¹<span id="originalQuote">0</span></p>
                <p><strong>Total Paid So Far:</strong> â‚¹<span id="totalPaid">0</span></p>
                <p><strong>Remaining Balance:</strong> â‚¹<span id="remainingBalance">0</span></p>
            </div>

            <!-- Payment Details -->
            <div id="paymentSection">
                <h4>Payment Details</h4>
                
                <div class="form-group">
                    <label for="paymentGateway">Payment Gateway *</label>
                    <select id="paymentGateway" required>
                        <option value="">Select Gateway</option>
                        <option value="razorpay">Razorpay</option>
                        <option value="payu">PayU</option>
                        <option value="phonepe">PhonePe</option>
                        <option value="googlepay">Google Pay</option>
                        <option value="paytm">Paytm</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="cash">Cash</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>

                <div class="amount-row">
                    <div class="form-group">
                        <label for="amountQuoted">Amount Quoted *</label>
                        <input type="number" id="amountQuoted" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="amountPaid">Amount Paid *</label>
                        <input type="number" id="amountPaid" min="0" step="0.01" required>
                        <div id="amountError" class="error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="balance">Balance</label>
                        <input type="number" id="balance" readonly class="readonly">
                    </div>
                </div>
            </div>

            <!-- Sales Rep Details -->
            <div class="form-group">
                <label for="salesRep">Sales Representative *</label>
                <select id="salesRep" required>
                    <option value="">Select Sales Rep</option>
                    <option value="Dharshan">Dharshan</option>
                    <option value="Surjeet">Surjeet</option>
                    <option value="Vivek">Vivek</option>
                    <option value="Sarthak">Sarthak</option>
                    <option value="Udhaya">Udhaya</option>
                    <option value="Varsha">Varsha</option>
                    <option value="100x">100x</option>
                </select>
            </div>

            <button type="submit" class="btn submit-btn" id="submitBtn">Submit Payment</button>
        </form>
    </div>

    <script>
        // REPLACE WITH YOUR GOOGLE APPS SCRIPT URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZ-PxYY3E0za-RnPYxX0qDkbhz-bamGfoBosE_7TlVUGUStxiGyjY_7ouOgmMaI8fD/exec';
        
        // Country Code Database
        const COUNTRIES = [
            { name: 'Afghanistan', code: 93 },
            { name: 'Albania', code: 355 },
            { name: 'Algeria', code: 213 },
            { name: 'American Samoa', code: 1 },
            { name: 'Andorra', code: 376 },
            { name: 'Angola', code: 244 },
            { name: 'Anguilla', code: 1 },
            { name: 'Antarctica', code: 672 },
            { name: 'Antigua and Barbuda', code: 1 },
            { name: 'Argentina', code: 54 },
            { name: 'Armenia', code: 374 },
            { name: 'Aruba', code: 297 },
            { name: 'Australia', code: 61 },
            { name: 'Austria', code: 43 },
            { name: 'Azerbaijan', code: 994 },
            { name: 'Bahamas', code: 1 },
            { name: 'Bahrain', code: 973 },
            { name: 'Bangladesh', code: 880 },
            { name: 'Barbados', code: 1 },
            { name: 'Belarus', code: 375 },
            { name: 'Belgium', code: 32 },
            { name: 'Belize', code: 501 },
            { name: 'Benin', code: 229 },
            { name: 'Bermuda', code: 1 },
            { name: 'Bhutan', code: 975 },
            { name: 'Bolivia', code: 591 },
            { name: 'Bosnia and Herzegovina', code: 387 },
            { name: 'Botswana', code: 267 },
            { name: 'Brazil', code: 55 },
            { name: 'British Virgin Islands', code: 1 },
            { name: 'Brunei', code: 673 },
            { name: 'Bulgaria', code: 359 },
            { name: 'Burkina Faso', code: 226 },
            { name: 'Burundi', code: 257 },
            { name: 'Cambodia', code: 855 },
            { name: 'Cameroon', code: 237 },
            { name: 'Canada', code: 1 },
            { name: 'Cape Verde', code: 238 },
            { name: 'Cayman Islands', code: 1 },
            { name: 'Central African Republic', code: 236 },
            { name: 'Chad', code: 235 },
            { name: 'Chile', code: 56 },
            { name: 'China', code: 86 },
            { name: 'Christmas Island', code: 61 },
            { name: 'Cocos Islands', code: 61 },
            { name: 'Colombia', code: 57 },
            { name: 'Comoros', code: 269 },
            { name: 'Congo', code: 242 },
            { name: 'Cook Islands', code: 682 },
            { name: 'Costa Rica', code: 506 },
            { name: 'Croatia', code: 385 },
            { name: 'Cuba', code: 53 },
            { name: 'Cyprus', code: 357 },
            { name: 'Czech Republic', code: 420 },
            { name: 'Democratic Republic of the Congo', code: 243 },
            { name: 'Denmark', code: 45 },
            { name: 'Djibouti', code: 253 },
            { name: 'Dominica', code: 1 },
            { name: 'Dominican Republic', code: 1 },
            { name: 'East Timor', code: 670 },
            { name: 'Ecuador', code: 593 },
            { name: 'Egypt', code: 20 },
            { name: 'El Salvador', code: 503 },
            { name: 'Equatorial Guinea', code: 240 },
            { name: 'Eritrea', code: 291 },
            { name: 'Estonia', code: 372 },
            { name: 'Ethiopia', code: 251 },
            { name: 'Falkland Islands', code: 500 },
            { name: 'Faroe Islands', code: 298 },
            { name: 'Fiji', code: 679 },
            { name: 'Finland', code: 358 },
            { name: 'France', code: 33 },
            { name: 'French Polynesia', code: 689 },
            { name: 'Gabon', code: 241 },
            { name: 'Gambia', code: 220 },
            { name: 'Georgia', code: 995 },
            { name: 'Germany', code: 49 },
            { name: 'Ghana', code: 233 },
            { name: 'Gibraltar', code: 350 },
            { name: 'Greece', code: 30 },
            { name: 'Greenland', code: 299 },
            { name: 'Grenada', code: 1 },
            { name: 'Guam', code: 1 },
            { name: 'Guatemala', code: 502 },
            { name: 'Guinea', code: 224 },
            { name: 'Guinea-Bissau', code: 245 },
            { name: 'Guyana', code: 592 },
            { name: 'Haiti', code: 509 },
            { name: 'Honduras', code: 504 },
            { name: 'Hong Kong', code: 852 },
            { name: 'Hungary', code: 36 },
            { name: 'Iceland', code: 354 },
            { name: 'India', code: 91 },
            { name: 'Indonesia', code: 62 },
            { name: 'Iran', code: 98 },
            { name: 'Iraq', code: 964 },
            { name: 'Ireland', code: 353 },
            { name: 'Israel', code: 972 },
            { name: 'Italy', code: 39 },
            { name: 'Ivory Coast', code: 225 },
            { name: 'Jamaica', code: 1 },
            { name: 'Japan', code: 81 },
            { name: 'Jordan', code: 962 },
            { name: 'Kazakhstan', code: 7 },
            { name: 'Kenya', code: 254 },
            { name: 'Kiribati', code: 686 },
            { name: 'Kuwait', code: 965 },
            { name: 'Kyrgyzstan', code: 996 },
            { name: 'Laos', code: 856 },
            { name: 'Latvia', code: 371 },
            { name: 'Lebanon', code: 961 },
            { name: 'Lesotho', code: 266 },
            { name: 'Liberia', code: 231 },
            { name: 'Libya', code: 218 },
            { name: 'Liechtenstein', code: 423 },
            { name: 'Lithuania', code: 370 },
            { name: 'Luxembourg', code: 352 },
            { name: 'Macau', code: 853 },
            { name: 'Macedonia', code: 389 },
            { name: 'Madagascar', code: 261 },
            { name: 'Malawi', code: 265 },
            { name: 'Malaysia', code: 60 },
            { name: 'Maldives', code: 960 },
            { name: 'Mali', code: 223 },
            { name: 'Malta', code: 356 },
            { name: 'Marshall Islands', code: 692 },
            { name: 'Mauritania', code: 222 },
            { name: 'Mauritius', code: 230 },
            { name: 'Mayotte', code: 262 },
            { name: 'Mexico', code: 52 },
            { name: 'Micronesia', code: 691 },
            { name: 'Moldova', code: 373 },
            { name: 'Monaco', code: 377 },
            { name: 'Mongolia', code: 976 },
            { name: 'Montenegro', code: 382 },
            { name: 'Montserrat', code: 1 },
            { name: 'Morocco', code: 212 },
            { name: 'Mozambique', code: 258 },
            { name: 'Myanmar', code: 95 },
            { name: 'Namibia', code: 264 },
            { name: 'Nauru', code: 674 },
            { name: 'Nepal', code: 977 },
            { name: 'Netherlands', code: 31 },
            { name: 'Netherlands Antilles', code: 599 },
            { name: 'New Caledonia', code: 687 },
            { name: 'New Zealand', code: 64 },
            { name: 'Nicaragua', code: 505 },
            { name: 'Niger', code: 227 },
            { name: 'Nigeria', code: 234 },
            { name: 'Niue', code: 683 },
            { name: 'Norfolk Island', code: 672 },
            { name: 'North Korea', code: 850 },
            { name: 'Northern Mariana Islands', code: 1 },
            { name: 'Norway', code: 47 },
            { name: 'Oman', code: 968 },
            { name: 'Pakistan', code: 92 },
            { name: 'Palau', code: 680 },
            { name: 'Palestine', code: 970 },
            { name: 'Panama', code: 507 },
            { name: 'Papua New Guinea', code: 675 },
            { name: 'Paraguay', code: 595 },
            { name: 'Peru', code: 51 },
            { name: 'Philippines', code: 63 },
            { name: 'Pitcairn', code: 870 },
            { name: 'Poland', code: 48 },
            { name: 'Portugal', code: 351 },
            { name: 'Puerto Rico', code: 1 },
            { name: 'Qatar', code: 974 },
            { name: 'Reunion', code: 262 },
            { name: 'Romania', code: 40 },
            { name: 'Russia', code: 7 },
            { name: 'Rwanda', code: 250 },
            { name: 'Saint Helena', code: 290 },
            { name: 'Saint Kitts and Nevis', code: 1 },
            { name: 'Saint Lucia', code: 1 },
            { name: 'Saint Pierre and Miquelon', code: 508 },
            { name: 'Saint Vincent and the Grenadines', code: 1 },
            { name: 'Samoa', code: 685 },
            { name: 'San Marino', code: 378 },
            { name: 'Sao Tome and Principe', code: 239 },
            { name: 'Saudi Arabia', code: 966 },
            { name: 'Senegal', code: 221 },
            { name: 'Serbia', code: 381 },
            { name: 'Seychelles', code: 248 },
            { name: 'Sierra Leone', code: 232 },
            { name: 'Singapore', code: 65 },
            { name: 'Slovakia', code: 421 },
            { name: 'Slovenia', code: 386 },
            { name: 'Solomon Islands', code: 677 },
            { name: 'Somalia', code: 252 },
            { name: 'South Africa', code: 27 },
            { name: 'South Korea', code: 82 },
            { name: 'South Sudan', code: 211 },
            { name: 'Spain', code: 34 },
            { name: 'Sri Lanka', code: 94 },
            { name: 'Sudan', code: 249 },
            { name: 'Suriname', code: 597 },
            { name: 'Swaziland', code: 268 },
            { name: 'Sweden', code: 46 },
            { name: 'Switzerland', code: 41 },
            { name: 'Syria', code: 963 },
            { name: 'Taiwan', code: 886 },
            { name: 'Tajikistan', code: 992 },
            { name: 'Tanzania', code: 255 },
            { name: 'Thailand', code: 66 },
            { name: 'Togo', code: 228 },
            { name: 'Tokelau', code: 690 },
            { name: 'Tonga', code: 676 },
            { name: 'Trinidad and Tobago', code: 1 },
            { name: 'Tunisia', code: 216 },
            { name: 'Turkey', code: 90 },
            { name: 'Turkmenistan', code: 993 },
            { name: 'Turks and Caicos Islands', code: 1 },
            { name: 'Tuvalu', code: 688 },
            { name: 'Uganda', code: 256 },
            { name: 'Ukraine', code: 380 },
            { name: 'United Arab Emirates', code: 971 },
            { name: 'United Kingdom', code: 44 },
            { name: 'United States', code: 1 },
            { name: 'Uruguay', code: 598 },
            { name: 'Uzbekistan', code: 998 },
            { name: 'Vanuatu', code: 678 },
            { name: 'Vatican', code: 39 },
            { name: 'Venezuela', code: 58 },
            { name: 'Vietnam', code: 84 },
            { name: 'Virgin Islands', code: 1 },
            { name: 'Wallis and Futuna', code: 681 },
            { name: 'Western Sahara', code: 212 },
            { name: 'Yemen', code: 967 },
            { name: 'Zambia', code: 260 },
            { name: 'Zimbabwe', code: 263 }
        ];

        // DOM Elements
        const paymentTypeSelect = document.getElementById('paymentType');
        const customerLookupSection = document.getElementById('customerLookup');
        const lookupEmailInput = document.getElementById('lookupEmail');
        const fetchCustomerBtn = document.getElementById('fetchCustomer');
        const customerSection = document.getElementById('customerSection');
        const balanceInfoSection = document.getElementById('balanceInfo');
        const form = document.getElementById('paymentForm');
        
        // Form inputs
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const countrySearchInput = document.getElementById('countrySearch');
        const countryDropdown = document.getElementById('countryDropdown');
        const countryCodeDisplay = document.getElementById('countryCodeDisplay');
        const phoneInput = document.getElementById('phone');
        const phonePreview = document.getElementById('phonePreview');
        const emailInput = document.getElementById('email');
        const amountQuotedInput = document.getElementById('amountQuoted');
        const amountPaidInput = document.getElementById('amountPaid');
        const balanceInput = document.getElementById('balance');
        const salesRepSelect = document.getElementById('salesRep');
        
        // Balance display elements
        const originalQuoteSpan = document.getElementById('originalQuote');
        const totalPaidSpan = document.getElementById('totalPaid');
        const remainingBalanceSpan = document.getElementById('remainingBalance');
        
        // Error elements
        const emailError = document.getElementById('emailError');
        const amountError = document.getElementById('amountError');

        let currentCustomerData = null;
        let selectedCountryCode = 91; // Default to India
        let highlightedIndex = -1;

        // Country search functionality
        countrySearchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const filtered = COUNTRIES.filter(country => 
                country.name.toLowerCase().includes(query)
            );
            
            renderCountryOptions(filtered);
            highlightedIndex = -1;
        });

        countrySearchInput.addEventListener('keydown', function(e) {
            const options = countryDropdown.querySelectorAll('.country-option');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
                updateHighlight(options);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightedIndex = Math.max(highlightedIndex - 1, -1);
                updateHighlight(options);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedIndex >= 0 && options[highlightedIndex]) {
                    selectCountry(options[highlightedIndex]);
                }
            } else if (e.key === 'Escape') {
                hideCountryDropdown();
            }
        });

        countrySearchInput.addEventListener('focus', function() {
            if (this.value) {
                const query = this.value.toLowerCase();
                const filtered = COUNTRIES.filter(country => 
                    country.name.toLowerCase().includes(query)
                );
                renderCountryOptions(filtered);
            } else {
                renderCountryOptions(COUNTRIES.slice(0, 10));
            }
        });

        function renderCountryOptions(countries) {
            countryDropdown.innerHTML = '';
            
            if (countries.length === 0) {
                countryDropdown.style.display = 'none';
                return;
            }

            countries.slice(0, 8).forEach((country, index) => {
                const option = document.createElement('div');
                option.className = 'country-option';
                option.textContent = `${country.name} (+${country.code})`;
                option.addEventListener('click', () => selectCountry(option));
                option.dataset.countryCode = country.code;
                option.dataset.countryName = country.name;
                countryDropdown.appendChild(option);
            });

            countryDropdown.style.display = 'block';
        }

        function updateHighlight(options) {
            options.forEach((option, index) => {
                option.classList.toggle('highlighted', index === highlightedIndex);
            });
        }

        function selectCountry(option) {
            const countryCode = option.dataset.countryCode;
            const countryName = option.dataset.countryName;
            
            selectedCountryCode = parseInt(countryCode);
            countrySearchInput.value = countryName;
            countryCodeDisplay.textContent = `+${countryCode}`;
            
            hideCountryDropdown();
            updatePhonePreview();
            phoneInput.focus();
        }

        function hideCountryDropdown() {
            countryDropdown.style.display = 'none';
            highlightedIndex = -1;
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.country-input-wrapper')) {
                hideCountryDropdown();
            }
        });

        // Phone number formatting
        function updatePhonePreview() {
            const phoneNumber = phoneInput.value.replace(/\D/g, '');
            const fullNumber = `+${selectedCountryCode}${phoneNumber}`;
            phonePreview.textContent = fullNumber;
        }

        phoneInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
            updatePhonePreview();
        });

        // Initialize
        countrySearchInput.value = 'India';
        selectedCountryCode = 91;
        countryCodeDisplay.textContent = '+91';
        updatePhonePreview();

        // Payment type change handler
        paymentTypeSelect.addEventListener('change', function() {
            const paymentType = this.value;
            
            if (paymentType === 'balance_partial' || paymentType === 'balance_completed') {
                customerLookupSection.classList.remove('hidden');
                setCustomerFieldsReadonly(true);
                balanceInfoSection.classList.remove('hidden');
                clearCustomerData();
            } else {
                customerLookupSection.classList.add('hidden');
                setCustomerFieldsReadonly(false);
                balanceInfoSection.classList.add('hidden');
                clearCustomerData();
                currentCustomerData = null;
            }
        });

        // Fetch customer button handler
        fetchCustomerBtn.addEventListener('click', async function() {
            const email = lookupEmailInput.value.trim();
            
            if (!email) {
                showError(emailError, 'Please enter customer email');
                return;
            }

            if (!isValidEmail(email)) {
                showError(emailError, 'Please enter a valid email address');
                return;
            }

            await fetchCustomerData(email);
        });

        // Amount calculation
        amountPaidInput.addEventListener('input', calculateBalance);
        amountQuotedInput.addEventListener('input', calculateBalance);

        // Fetch customer data function
        async function fetchCustomerData(email) {
            try {
                setLoading(true);
                clearError(emailError);

                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'fetchCustomer',
                        email: email
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                
                if (result.success && result.data) {
                    currentCustomerData = result.data;
                    populateCustomerData(result.data);
                    showSuccess(emailError, 'Customer data loaded successfully!');
                } else {
                    showError(emailError, result.message || 'Customer not found');
                    currentCustomerData = null;
                }
            } catch (error) {
                showError(emailError, 'Error fetching customer data. Please try again.');
                console.error('Fetch error:', error);
            } finally {
                setLoading(false);
            }
        }

        // Populate customer data
        function populateCustomerData(data) {
            firstNameInput.value = data.firstName;
            lastNameInput.value = data.lastName;
            
            // Handle phone number with country code
            if (data.phone) {
                const phoneStr = data.phone.toString();
                const matchedCountry = COUNTRIES.find(country => 
                    phoneStr.startsWith(`+${country.code}`)
                );
                
                if (matchedCountry) {
                    selectedCountryCode = matchedCountry.code;
                    countrySearchInput.value = matchedCountry.name;
                    countryCodeDisplay.textContent = `+${matchedCountry.code}`;
                    phoneInput.value = phoneStr.substring(matchedCountry.code.toString().length + 1);
                } else {
                    selectedCountryCode = 91;
                    countrySearchInput.value = 'India';
                    countryCodeDisplay.textContent = '+91';
                    phoneInput.value = phoneStr.replace(/\D/g, '');
                }
                updatePhonePreview();
            }
            
            emailInput.value = data.email;
            amountQuotedInput.value = data.amountQuoted;

            // Update balance information
            originalQuoteSpan.textContent = data.amountQuoted.toLocaleString();
            totalPaidSpan.textContent = data.totalPaid.toLocaleString();
            remainingBalanceSpan.textContent = (data.amountQuoted - data.totalPaid).toLocaleString();

            calculateBalance();
        }

        // Calculate balance
        function calculateBalance() {
            const quoted = parseFloat(amountQuotedInput.value) || 0;
            const paid = parseFloat(amountPaidInput.value) || 0;
            let balance = quoted - paid;

            if (currentCustomerData && (paymentTypeSelect.value === 'balance_partial' || paymentTypeSelect.value === 'balance_completed')) {
                const remainingBalance = currentCustomerData.amountQuoted - currentCustomerData.totalPaid;
                balance = remainingBalance - paid;

                if (paid > remainingBalance) {
                    showError(amountError, `Payment cannot exceed remaining balance of â‚¹${remainingBalance.toLocaleString()}`);
                    balanceInput.value = '';
                    return;
                } else {
                    clearError(amountError);
                }
            }

            balanceInput.value = Math.max(0, balance);
        }

        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            try {
                setLoading(true);
                const formData = collectFormData();
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'submitPayment',
                        ...formData
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();
                
                if (result.success) {
                    alert('Payment recorded successfully!');
                    form.reset();
                    resetForm();
                } else {
                    alert('Error submitting payment: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Error submitting payment. Please check your internet connection and try again.');
            } finally {
                setLoading(false);
            }
        });

        // Collect form data
        function collectFormData() {
            const fullPhoneNumber = `+${selectedCountryCode}${phoneInput.value.replace(/\D/g, '')}`;
            
            return {
                paymentType: paymentTypeSelect.value,
                firstName: firstNameInput.value,
                lastName: lastNameInput.value,
                phone: fullPhoneNumber,
                email: emailInput.value,
                paymentGateway: document.getElementById('paymentGateway').value,
                amountQuoted: parseFloat(amountQuotedInput.value),
                amountPaid: parseFloat(amountPaidInput.value),
                balance: parseFloat(balanceInput.value),
                salesRep: salesRepSelect.value,
                timestamp: new Date().toISOString(),
                existingCustomer: !!currentCustomerData
            };
        }

        // Utility functions
        function setCustomerFieldsReadonly(readonly) {
            const fields = [firstNameInput, lastNameInput, phoneInput, emailInput, amountQuotedInput];
            fields.forEach(field => {
                if (readonly) {
                    field.setAttribute('readonly', 'readonly');
                    field.classList.add('readonly');
                } else {
                    field.removeAttribute('readonly');
                    field.classList.remove('readonly');
                }
            });
            
            if (readonly) {
                countrySearchInput.setAttribute('disabled', 'disabled');
                countrySearchInput.classList.add('readonly');
            } else {
                countrySearchInput.removeAttribute('disabled');
                countrySearchInput.classList.remove('readonly');
            }
        }

        function clearCustomerData() {
            firstNameInput.value = '';
            lastNameInput.value = '';
            countrySearchInput.value = 'India';
            selectedCountryCode = 91;
            countryCodeDisplay.textContent = '+91';
            phoneInput.value = '';
            emailInput.value = '';
            amountQuotedInput.value = '';
            amountPaidInput.value = '';
            balanceInput.value = '';
            lookupEmailInput.value = '';
            updatePhonePreview();
            clearError(emailError);
            clearError(amountError);
        }

        function resetForm() {
            customerLookupSection.classList.add('hidden');
            balanceInfoSection.classList.add('hidden');
            setCustomerFieldsReadonly(false);
            currentCustomerData = null;
            countrySearchInput.value = 'India';
            selectedCountryCode = 91;
            countryCodeDisplay.textContent = '+91';
            updatePhonePreview();
        }

        function validateForm() {
            let isValid = true;

            if (currentCustomerData && (paymentTypeSelect.value === 'balance_partial' || paymentTypeSelect.value === 'balance_completed')) {
                const paid = parseFloat(amountPaidInput.value) || 0;
                const remainingBalance = currentCustomerData.amountQuoted - currentCustomerData.totalPaid;
                
                if (paid > remainingBalance) {
                    showError(amountError, `Payment cannot exceed remaining balance of â‚¹${remainingBalance.toLocaleString()}`);
                    isValid = false;
                }

                if (paymentTypeSelect.value === 'balance_completed' && paid !== remainingBalance) {
                    showError(amountError, `For balance completed, payment must equal remaining balance of â‚¹${remainingBalance.toLocaleString()}`);
                    isValid = false;
                }
            }

            return isValid;
        }

        function setLoading(loading) {
            if (loading) {
                form.classList.add('loading');
                fetchCustomerBtn.textContent = 'Fetching...';
            } else {
                form.classList.remove('loading');
                fetchCustomerBtn.textContent = 'Fetch Customer Details';
            }
        }

        function showError(element, message) {
            element.textContent = message;
            element.className = 'error';
        }

        function showSuccess(element, message) {
            element.textContent = message;
            element.className = 'success';
        }

        function clearError(element) {
            element.textContent = '';
        }

        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
    </script>
</body>
</html>
